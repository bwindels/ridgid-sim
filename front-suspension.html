<!DOCTYPE html>
<html>
<head>
	<title></title>
	<meta charset="utf-8">
</head>
<body>
	<div>
		Shock length: <input type="range" id="shockLen" min="10" max="15" value="12" step="any">
	</div>
<svg id="drawing" viewBox="-10 -30 60 60" width="400" height="400" xmlns="http://www.w3.org/2000/svg"></svg>
<script type="module">
	import {Rod} from "./src/rod.js";
	import {Anchor} from "./src/link.js";
	import {resolve} from "./src/resolve.js";

	function run(sim, input) {
		const anchors = suspension(input);
		const resolvedBodies = resolve(anchors);
		for (let i = 0; i < resolvedBodies.length; i += 1) {
			const rb = resolvedBodies[i];
			const node = drawing.childNodes[i];
			if (node) {
				rb.updateNode(node);
			} else {
				drawing.appendChild(rb.renderNode());
			}
		}
		// const circle = drawing.childNodes[4] || document.createElementNS("http://www.w3.org/2000/svg", "circle");
		// circle.setAttribute("cx", resolvedBodies[3].points[1].x);
		// circle.setAttribute("cy", resolvedBodies[3].points[1].y);
		// circle.setAttribute("stroke", "grey");
		// circle.setAttribute("fill", "none");
		// circle.setAttribute("r", 20);
		// drawing.appendChild(circle);
	}

	function suspension(input) {
		const shock = new Rod(input.shockLen, {name: "shock", color: "blue"});
		const bottomArm = new Rod(25, {name: "bottomArm", color: "red"});
		const topArm = new Rod(13, {name: "topArm", color: "red"});
		const kingPin = new Rod(10, {name: "kingPin", color: "green"});

		const anchors = {
			shock: new Anchor(8, -4),
			bottomArm: new Anchor(0, 0),
			topArm: new Anchor(10, -10),
		};

		anchors.shock.link(shock.start);
		shock.end.link(bottomArm.addMount(18));

		anchors.bottomArm.link(bottomArm.start);
		anchors.topArm.link(topArm.start);

		topArm.end.link(kingPin.start);
		bottomArm.end.link(kingPin.end);

		return Object.values(anchors);
	}

	let start = 15;
	const duration = 2000;
	let targetStart = performance.now();
	let target = 10;

	function animate(ts) {
		const delta = (ts - targetStart) / duration;
		const value = start + ((target - start) * delta);

		run(suspension, {shockLen: value});

		if (delta >= 1) {
			const tmp = start;
			start = target;
			target = tmp;
			targetStart = ts;
		}
		requestAnimationFrame(animate);
	}
	//requestAnimationFrame(animate);
	const range = document.getElementById("shockLen");
	range.addEventListener("input", evt => {
		try {
			run(suspension, {shockLen: parseFloat(range.value)});
			range.setCustomValidity("");
		} catch (err) {
			range.setCustomValidity(err.message);
			range.reportValidity();
		}
	});
	run(suspension, {shockLen: parseFloat(range.value)});

//run(suspension, {shockLen: 10}); //17 fails	

</script>
</body>
</html>